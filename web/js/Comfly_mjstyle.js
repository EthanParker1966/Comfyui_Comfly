import{app}from"../../../scripts/app.js";import{$el}from"../../../scripts/ui.js";let pb_cache={};async function getStyles(e){if(pb_cache[e])return pb_cache[e];{const t=await fetch(`http://localhost:8080/mjstyle/${e}.json`);if(200===t.status){let o=await t.json();return pb_cache[e]=o,o}return}}function createTagElement(e,t,o){return $el("label.Comfly_style-model-tag.comfy-btn",{dataset:{tag:e.name,name:e.name,negativePrompt:e.negative_prompt},style:{margin:"5px",display:"inline-flex",alignItems:"center",justifyContent:"space-between",fontSize:"16px"},onclick:t=>{t.preventDefault(),t.stopPropagation();let l=t.currentTarget.querySelector("input[type='checkbox']");l.checked=!l.checked,t.currentTarget.classList.toggle("Comfly_style-model-tag--selected",l.checked),o(e,l.checked)}},[$el("span",{textContent:e.name}),$el("input",{type:"checkbox",checked:t,style:{accentColor:"var(--comfy-menu-bg)"}})])}app.registerExtension({name:"Comfly_mjstyle",async beforeRegisterNodeDef(e,t,o){if(["Comfly_mjstyle"].indexOf(t.name)>=0){const t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){const e=t?.apply(this,arguments);let o=this.widgets.find((e=>"styles_type"===e.name));this.setProperty("values",[]);const l=$el("div",{style:{display:"none"}},[$el("div",{textContent:"Selected Styles:",style:{marginBottom:"5px",fontWeight:"bold",fontSize:"18px"}}),$el("div.Comfly_selected-tags-list",{style:{marginBottom:"10px",padding:"5px",border:"1px solid var(--border-color)",borderRadius:"5px",maxHeight:"100px",overflowY:"auto"}})]),s=$el("div.Comfly_style-model-tags-list",{style:{height:"200px",overflowY:"auto",backgroundColor:"var(--comfy-menu-bg)",color:"var(--fg-color)",border:"1px solid var(--border-color)",borderRadius:"5px",padding:"5px",display:"none"},onwheel:e=>{e.stopPropagation()}}),i=$el("button.comfy-btn",{textContent:"Clear all",style:{marginTop:"10px",alignSelf:"flex-end",fontSize:"16px",padding:"4px 10px"},onclick:()=>{this.properties.values=[],r(),a()}});let n=this.addDOMWidget("button","btn",$el("div.Comfly_style-preview",{style:{display:"flex",flexDirection:"column",alignItems:"stretch",position:"relative",height:"100%"}},[l,$el("div",{textContent:"Available Styles:",style:{marginTop:"10px",marginBottom:"5px",fontWeight:"bold",fontSize:"18px"}}),s,$el("div",{style:{display:"flex",justifyContent:"flex-end"}},[i])]));const r=()=>{const e=l.querySelector(".Comfly_selected-tags-list");e.innerHTML="",this.properties.values.length>0?(l.style.display="block",this.properties.values.forEach((t=>{e.appendChild(createTagElement({name:t,negative_prompt:""},!0,((e,t)=>{t||(this.properties.values=this.properties.values.filter((t=>t!==e.name)),r(),a())})))}))):l.style.display="none"},a=()=>{pb_cache[p]&&(s.innerHTML="",pb_cache[p].forEach((e=>{const t=this.properties.values.includes(e.name);s.appendChild(createTagElement(e,t,((e,t)=>{t?this.properties.values.includes(e.name)||this.properties.values.push(e.name):this.properties.values=this.properties.values.filter((t=>t!==e.name)),r()})))})))};let p="";Object.defineProperty(o,"value",{set:e=>{p=e,p?getStyles(p).then((e=>{e&&(pb_cache[p]=e,a(),r(),s.style.display="block")})):(s.innerHTML="",s.style.display="none")},get:()=>p});let c="";return Object.defineProperty(n,"value",{set:e=>{},get:()=>{let e=this.properties.values,t="";return e.forEach((e=>{const o=pb_cache[p]?.find((t=>t.name===e));o&&o.negative_prompt&&(t+=o.negative_prompt+", ")})),c=e.join(","),this.properties.style_positive=e.join(", "),this.properties.style_negative=t.trim(),c}}),this.setSize([500,550]),e}}}});